{{ $riCornerDownRightLine := resources.Get "img/ri/corner-down-right-line.svg" }}
{{ $riGithubFill := resources.Get "img/ri/github-fill.svg" }}
{{ $riLinkedInBoxFill := resources.Get "img/ri/linkedin-box-fill.svg" }}
{{ $riDiscordFill := resources.Get "img/ri/discord-fill.svg" }}
{{ $riDiscordFill := resources.Get "img/ri/discord-fill.svg" }}
{{ $riHome5Fill := resources.Get "img/ri/home-5-fill.svg" }}

{{ $currentPage := . }}
{{ $versionId := "" }}

{{ $versionName := .Params.plakarVersion | default "" }}
{{ $docsSection := .Site.GetPage "section" "docs" }}
{{ range $index, $subsection := $docsSection.Sections }}
{{ if $subsection.IsAncestor $currentPage }}
{{ $versionId = partial "sidebar/version-id" (dict "title" $subsection.Title "index" $index) }}
{{ if not $versionName }}
{{ $versionName = $subsection.Params.plakarVersion | default $subsection.Title }}
{{ end }}
{{ end }}
{{ end }}

{{ $latestVersion := "v1.0.6" }}
{{ $isOldVersion := and (ne $versionName "main") (ne $versionName $latestVersion) (ne $versionName "") }}

{{ $latestUrl := "" }}
{{ if $isOldVersion }}
{{ $currentPath := strings.TrimPrefix "/docs/" .RelPermalink }}
{{ $pathParts := split $currentPath "/" }}
{{ if gt (len $pathParts) 1 }}
{{ $pathWithoutVersion := delimit (after 1 $pathParts) "/" }}
{{ $latestUrl = printf "/docs/%s/%s" $latestVersion $pathWithoutVersion }}
{{ end }}
{{ end }}

<section class="section-light-1 w-full">
    <div class="content flex flex-col 2xl:flex-row-reverse items-start">
        <!-- Sidebar (right) -->
        <aside
            class="xl:right-0 xl:sticky w-full h-full 2xl:w-[340px] max-w-full px-8 2xl:px-0 2xl:max-w-[calc((100%-680px-32px)/2)] pb-4 2xl:pe-4 lg:top-28 flex flex-col  mx-auto 2xl:mx-0">
            <div
                class="~text-xs/lg font-prose flex flex-col gap-6 p-2 2xl:p-4 bg-neutral-50 2xl:border-r border-dotted ">
                {{ partial "toc-docs.html" . }}
            </div>
        </aside>

        <!-- Article content (right)  -->
        <article class="max-w-full flex-1 flex flex-col gap-4 bg-neutral-50 overflow-hidden pb-8">
            <div class="article-header ps-8 pe-2 md:pe-8 flex flex-col gap-4 pt-8">
                <!-- Breadcrumbs -->
                <div class="flex flex-wrap items-center gap-2 text-sm font-space-grotesk">
                    <a href="/docs/"
                        class="flex items-center text-primary-500 hover:text-primary-600 transition-colors">
                        <div class="w-4 h-4">
                            {{ $riHome5Fill.Content | safeHTML }}
                        </div>
                    </a>
                    {{ $url := replace .Permalink ( printf "%s" .Site.BaseURL) "" }}
                    {{ $elements := split $url "/" }}
                    {{ $scratch := newScratch }}
                    {{ $scratch.Set "path" "/" }}
                    {{ $firstElement := true }}

                    {{ range $index, $element := $elements }}
                    {{ if ne $element "" }}
                    {{ $scratch.Add "path" (print $element "/") }}
                    {{ $currentPath := $scratch.Get "path" }}

                    {{ if and (ne $element "docs") (ne $firstElement false) }}
                    <span class="flex items-center">
                        {{ if ne $index (sub (len $elements) 2) }}
                        {{ if ne $element "docs" }}
                        <a href="{{ $currentPath }}" class="text-primary-500 hover:text-primary-600 transition-colors">
                            {{ humanize (replace $element "-" " ") }}
                        </a>
                        {{ end }}
                        {{ else }}
                        <span class="text-neutral-900 font-medium">{{ humanize (replace $element "-" " ") }}</span>
                        {{ end }}
                    </span>
                    {{ $firstElement = false }}
                    {{ else if ne $firstElement true }}
                    <span class="flex items-center">
                        <img src="{{ $riCornerDownRightLine.RelPermalink }}" alt=">"
                            class="w-4 h-4 text-neutral-400 me-2">
                        {{ if ne $index (sub (len $elements) 2) }}
                        {{ if ne $element "docs" }}
                        <a href="{{ $currentPath }}" class="text-primary-500 hover:text-primary-600 transition-colors">
                            {{ humanize (replace $element "-" " ") }}
                        </a>
                        {{ end }}
                        {{ else }}
                        <span class="text-neutral-900 font-medium">{{ humanize (replace $element "-" " ") }}</span>
                        {{ end }}
                    </span>
                    {{ else }}
                    {{ if ne $index (sub (len $elements) 2) }}
                    {{ if ne $element "docs" }}
                    <a href="{{ $currentPath }}" class="text-primary-500 hover:text-primary-600 transition-colors">
                        {{ humanize (replace $element "-" " ") }}
                    </a>
                    {{ end }}
                    {{ else }}
                    <span class="text-neutral-900 font-medium">{{ humanize (replace $element "-" " ") }}</span>
                    {{ end }}
                    {{ $firstElement = false }}
                    {{ end }}
                    {{ end }}
                    {{ end }}
                </div>

                <div
                    class="inline-flex px-2 w-max py-1 rounded-md text-xs font-space-grotesk  text-neutral-900 border border-neutral-900">
                    <span>Version {{ $versionName | default "latest" }}</span>
                </div>

                <!-- Version Warning Banner -->
                {{ if $isOldVersion }}
                <div class="bg-amber-50 border border-amber-300 shadow-sm">
                    <div class="px-6 md:px-8 py-5">
                        <div class="flex items-start gap-4">
                            <div class="flex-shrink-0 mt-0.5">
                                <div class="w-10 h-10 rounded-full bg-amber-100 flex items-center justify-center">
                                    <svg class="w-14 h-14 text-amber-600" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
                                    </svg>
                                </div>
                            </div>
                            <div class="flex-1 min-w-0">
                                <h3 class="text-base font-semibold text-amber-900 font-space-grotesk mb-1">
                                    Outdated Documentation
                                </h3>
                                <p class="text-sm text-amber-800 font-space-grotesk leading-relaxed">
                                    You're viewing documentation for version <span class="font-semibold">{{ $versionName }}</span>.
                                    This version may contain outdated information.
                                </p>
                                <div class="mt-4">
                                    {{ if $latestUrl }}
                                    <a href="{{ $latestUrl }}"
                                       class="items-center gap-2 px-3 py-2 bg-primary-500  hover:bg-primary-600 text-white text-sm font-semibold font-space-grotesk rounded-md transition-colors duration-200 shadow-sm hover:shadow">
                                        <span>View Latest Version ({{ $latestVersion }})</span>
                                    </a>
                                    {{ else }}
                                    <a href="/docs/{{ $latestVersion }}/"
                                       class="items-center gap-2 px-3 py-2 bg-primary-500  hover:bg-primary-600 text-white text-sm font-semibold font-space-grotesk rounded-md transition-colors duration-200 shadow-sm hover:shadow">
                                        <span>Go to Latest Docs ({{ $latestVersion }})</span>
                                    </a>
                                    {{ end }}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {{ end }}

                <h1 class="font-prose font-bold leading-tight ~text-3xl/4xl">
                    {{ .Title | emojify }}
                </h1>
            </div>

            <div class="article-wrapper relative">
                <!-- Content blocks -->
                <div class="relative docs-content font-prose prose text-base w-full max-w-full ps-8 pe-2 md:pe-8">
                    {{ .Content | safeHTML }}
                </div>
            </div>

            <!-- Documentation Feedback Section -->
            <div class="ps-8 pe-2 md:pe-8 mt-8">
                <div class="border-t border-neutral-300 pt-6">
                    <p class="text-sm text-neutral-600 font-prose">
                        Found a bug or mistake in the documentation?
                        <a href="https://github.com/PlakarKorp/plakar.io/issues/new"
                           target="_blank"
                           rel="noopener noreferrer"
                           class="text-primary-500 hover:text-primary-600 underline">
                            Create an issue on GitHub
                        </a>
                    </p>
                </div>
            </div>

            <div
                class="bg-neutral-200 border-neutral-300 flex justify-center items-center gap-3 py-4 px-4 flex-wrap w-full max-w-full">
                <div class="flex gap-4 items-center">
                    {{ partial "social/bluesky-badge.html" . }}
                    {{ partial "social/discord-badge.html" . }}
                    {{ partial "social/linkedin-badge.html" . }}
                    {{ partial "social/github-badge.html" (dict "format" "icon" "context" .) }}
                </div>
            </div>
        </article>
    </div>
</section>

<script>
    document.querySelectorAll('.article-content img').forEach(img => {
        img.addEventListener('click', () => {
            basicLightbox.create(`<img src="${img.src}" />`).show();
        });
    });
</script>
